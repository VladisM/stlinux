From 08e475b1c62b3c5e6153cf0d86b70d8d61de6408 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bc=2E=20Vladislav=20Mlejneck=C3=BD?= <v.mlejnecky@seznam.cz>
Date: Mon, 8 May 2023 19:38:52 +0200
Subject: [PATCH 02/15] Fixed bank sizes of internal flash memory on STM32F4

---
 arch/arm/include/asm/arch-stm32f4/stm32.h | 13 ++++++++++---
 drivers/mtd/stm32_flash.c                 |  6 ++++--
 2 files changed, 14 insertions(+), 5 deletions(-)

diff --git a/arch/arm/include/asm/arch-stm32f4/stm32.h b/arch/arm/include/asm/arch-stm32f4/stm32.h
index 2094bd7321..eeca8ac513 100644
--- a/arch/arm/include/asm/arch-stm32f4/stm32.h
+++ b/arch/arm/include/asm/arch-stm32f4/stm32.h
@@ -32,9 +32,16 @@ struct stm32_u_id_regs {
 #define STM32_U_ID_BASE		(STM32_SYSMEM_BASE + 0x7A10)
 #define STM32_U_ID		((struct stm32_u_id_regs *)STM32_U_ID_BASE)
 static const u32 sect_sz_kb[CONFIG_SYS_MAX_FLASH_SECT] = {
-	[0 ... 3] =	16 * 1024,
-	[4] =		64 * 1024,
-	[5 ... 11] =	128 * 1024
+#if CONFIG_SYS_MAX_FLASH_SECT < 5
+	[0 ... CONFIG_SYS_MAX_FLASH_SECT - 1] = 16 * 1024,
+#elif CONFIG_SYS_MAX_FLASH_SECT == 5
+	[0 ... 3] = 16 * 1024,
+	[4] =       64 * 1024
+#elif CONFIG_SYS_MAX_FLASH_SECT > 5
+	[0 ... 3] = 16 * 1024,
+	[4] =       64 * 1024,
+	[5 ... CONFIG_SYS_MAX_FLASH_SECT - 1] = 128 * 1024
+#endif
 };
 
 #endif /* _MACH_STM32_H_ */
diff --git a/drivers/mtd/stm32_flash.c b/drivers/mtd/stm32_flash.c
index 4523344ba6..1b21e3fa2b 100644
--- a/drivers/mtd/stm32_flash.c
+++ b/drivers/mtd/stm32_flash.c
@@ -9,6 +9,7 @@
 #include <asm/io.h>
 #include <asm/arch/stm32.h>
 #include "stm32_flash.h"
+#include <display_options.h>
 
 flash_info_t flash_info[CONFIG_SYS_MAX_FLASH_BANKS];
 
@@ -63,8 +64,9 @@ void flash_print_info(flash_info_t *info)
 		printf("stm32 Embedded Flash\n");
 	}
 
-	printf("  Size: %ld MB in %d Sectors\n",
-	       info->size >> 20, info->sector_count);
+	printf("  Size: ");
+	print_size(info->size, "");
+	printf(" in %d Sectors\n", info->sector_count);
 
 	printf("  Sector Start Addresses:");
 	for (i = 0; i < info->sector_count; ++i) {
-- 
2.46.0

