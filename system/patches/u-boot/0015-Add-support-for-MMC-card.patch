From 38480198584a171b29e7d03e1c4ac8ef8bf27ee7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bc=2E=20Vladislav=20Mlejneck=C3=BD?= <v.mlejnecky@seznam.cz>
Date: Sun, 1 Oct 2023 13:59:12 +0200
Subject: [PATCH 15/15] Add support for MMC card

---
 arch/arm/dts/stm32f446-stlinux-u-boot.dtsi | 15 +++++++++++++++
 arch/arm/dts/stm32f446-stlinux.dts         | 17 +++++++++++++++++
 arch/arm/dts/stm32f446.dtsi                | 10 ++++++++++
 configs/stm32f446-stlinux_defconfig        |  8 +++++++-
 4 files changed, 49 insertions(+), 1 deletion(-)

diff --git a/arch/arm/dts/stm32f446-stlinux-u-boot.dtsi b/arch/arm/dts/stm32f446-stlinux-u-boot.dtsi
index cad6847325..44b7ae4af1 100644
--- a/arch/arm/dts/stm32f446-stlinux-u-boot.dtsi
+++ b/arch/arm/dts/stm32f446-stlinux-u-boot.dtsi
@@ -201,6 +201,17 @@
 			u-boot,dm-pre-reloc;
 		};
 	};
+
+	sdio_pins_od: sdio-pins-od-0 {
+		u-boot,dm-pre-reloc;
+		pins1 {
+			u-boot,dm-pre-reloc;
+		};
+
+		pins2 {
+			u-boot,dm-pre-reloc;
+		};
+	};
 };
 
 &pwrcfg {
@@ -218,3 +229,7 @@
 &timers5 {
 	u-boot,dm-pre-reloc;
 };
+
+&sdio {
+	u-boot,dm-pre-reloc;
+};
diff --git a/arch/arm/dts/stm32f446-stlinux.dts b/arch/arm/dts/stm32f446-stlinux.dts
index 6aa43dce76..68a9bc327d 100644
--- a/arch/arm/dts/stm32f446-stlinux.dts
+++ b/arch/arm/dts/stm32f446-stlinux.dts
@@ -29,6 +29,13 @@
 		serial0 = &usart2;
 	};
 
+	main_vreg_3V3: main_vreg_3V3 {
+		compatible = "regulator-fixed";
+		regulator-name = "main_vreg_3V3";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+	};
+
 	leds {
 		compatible = "gpio-leds";
 		led_user_0 {
@@ -73,3 +80,13 @@
 	pinctrl-names = "default";
 	status = "okay";
 };
+
+&sdio {
+	status = "okay";
+	cd-gpios = <&gpioc 1 GPIO_ACTIVE_LOW>;
+	pinctrl-names = "default", "opendrain";
+	pinctrl-0 = <&sdio_pins>;
+	pinctrl-1 = <&sdio_pins_od>;
+	bus-width = <4>;
+	vmmc-supply = <&main_vreg_3V3>;
+};
diff --git a/arch/arm/dts/stm32f446.dtsi b/arch/arm/dts/stm32f446.dtsi
index ad7bf39a86..c2945b1bca 100644
--- a/arch/arm/dts/stm32f446.dtsi
+++ b/arch/arm/dts/stm32f446.dtsi
@@ -156,6 +156,16 @@
 			#dma-cells = <4>;
 			st,mem2mem;
 		};
+
+		sdio: mmc@40012c00 {
+			compatible = "arm,pl180", "arm,primecell";
+			arm,primecell-periphid = <0x00880180>;
+			reg = <0x40012c00 0x400>;
+			clocks = <&rcc 0 STM32F4_APB2_CLOCK(SDIO)>;
+			clock-names = "apb_pclk";
+			interrupts = <49>;
+			max-frequency = <48000000>;
+		};
 	};
 };
 
diff --git a/configs/stm32f446-stlinux_defconfig b/configs/stm32f446-stlinux_defconfig
index 169f263802..afcd2c304c 100644
--- a/configs/stm32f446-stlinux_defconfig
+++ b/configs/stm32f446-stlinux_defconfig
@@ -21,16 +21,22 @@ CONFIG_HUSH_PARSER=y
 CONFIG_SYS_PBSIZE=1050
 CONFIG_CMD_BOOTZ=y
 CONFIG_CMD_IMLS=y
+CONFIG_CMD_MMC=y
 CONFIG_CMD_MTD=y
 # CONFIG_CMD_SETEXPR is not set
 CONFIG_CMD_TIMER=y
+CONFIG_CMD_FAT=y
+CONFIG_CMD_FS_GENERIC=y
 CONFIG_OF_CONTROL=y
 CONFIG_OF_EMBED=y
 CONFIG_ENV_SOURCE_FILE="stlinux"
 # CONFIG_NET is not set
 CONFIG_LED=y
 CONFIG_LED_GPIO=y
-# CONFIG_MMC is not set
+# CONFIG_MMC_WRITE is not set
+CONFIG_MMC_BROKEN_CD=y
+CONFIG_ARM_PL180_MMCI=y
+# CONFIG_MMC_HW_PARTITIONING is not set
 CONFIG_MTD=y
 CONFIG_DM_MTD=y
 CONFIG_MTD_NOR_FLASH=y
-- 
2.46.0

