From 600d9b28a6bfe9fce4e3737836d3469107d58886 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bc=2E=20Vladislav=20Mlejneck=C3=BD?= <v.mlejnecky@seznam.cz>
Date: Sun, 1 Oct 2023 14:06:11 +0200
Subject: [PATCH 3/3] Add support for MMC

---
 arch/arm/boot/dts/stm32f446-stlinux.dts | 43 ++++++++++++++++++++++++-
 1 file changed, 42 insertions(+), 1 deletion(-)

diff --git a/arch/arm/boot/dts/stm32f446-stlinux.dts b/arch/arm/boot/dts/stm32f446-stlinux.dts
index 8369ba04fb4d..69308872dc0e 100644
--- a/arch/arm/boot/dts/stm32f446-stlinux.dts
+++ b/arch/arm/boot/dts/stm32f446-stlinux.dts
@@ -84,6 +84,37 @@ pins {
 			slew-rate = <3>;
 		};
 	};
+
+	sdio_pins: sdio-pins-0 {
+		pins {
+			pinmux = <STM32_PINMUX('C', 8, AF12)>, /* SDIO_D0 */
+					<STM32_PINMUX('C', 9, AF12)>, /* SDIO_D1 */
+					<STM32_PINMUX('C', 10, AF12)>, /* SDIO_D2 */
+					<STM32_PINMUX('C', 11, AF12)>, /* SDIO_D3 */
+					<STM32_PINMUX('C', 12, AF12)>, /* SDIO_CK */
+					<STM32_PINMUX('D', 2, AF12)>; /* SDIO_CMD */
+			drive-push-pull;
+			slew-rate = <2>;
+		};
+	};
+
+	sdio_pins_od: sdio-pins-od-0 {
+		pins1 {
+			pinmux = <STM32_PINMUX('C', 8, AF12)>, /* SDIO_D0 */
+					<STM32_PINMUX('C', 9, AF12)>, /* SDIO_D1 */
+					<STM32_PINMUX('C', 10, AF12)>, /* SDIO_D2 */
+					<STM32_PINMUX('C', 11, AF12)>, /* SDIO_D3 */
+					<STM32_PINMUX('C', 12, AF12)>; /* SDIO_CK */
+			drive-push-pull;
+			slew-rate = <2>;
+		};
+
+		pins2 {
+			pinmux = <STM32_PINMUX('D', 2, AF12)>; /* SDIO_CMD */
+			drive-open-drain;
+			slew-rate = <2>;
+		};
+	};
 };
 
 &clk_hse {
@@ -135,8 +166,8 @@ &usart2 {
 };
 
 &i2c1 {
-	pinctrl-names = "default";
 	pinctrl-0 = <&i2c1_pins>;
+	pinctrl-names = "default";
 	clock-frequency = <100000>;
 	status = "okay";
 
@@ -145,3 +176,13 @@ eeprom@50 {
 		reg = <0x50>;
 	};
 };
+
+&sdio {
+	status = "okay";
+	cd-gpios = <&gpioc 1 GPIO_ACTIVE_LOW>;
+	pinctrl-names = "default", "opendrain";
+	pinctrl-0 = <&sdio_pins>;
+	pinctrl-1 = <&sdio_pins_od>;
+	bus-width = <4>;
+	vmmc-supply = <&main_vreg_3V3>;
+};
-- 
2.46.0

